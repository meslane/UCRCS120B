/*
 * sprite.c
 *
 * Created: 11/20/2021 12:35:19 PM
 *  Author: Merrick
 */ 
#include "sprite.h"
#include "io.h"

/* The LCD only allows 8 custom chars at a time and will overwrite all if you update the table
 * This is a limitation, but we can use this to our advantage
 *
 * Only 1 TIE is allowed on screen at a time
 * Up to 2 ship lasers are allowed
 * 1 ground laser is allowed
 * 1 torpedo is allowed
 * counters will keep track of this
 *
 * Now, in order to update vertical XWing position within one cell, we only need to overwrite the sprite table
 * Other chars will move around the XWing so they must be doubly updated
*/

unsigned char xWingSprites[8][8] = {
	{0x1c, 0x0F, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x1c, 0x0F, 0x1c, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x1c, 0x0F, 0x1c, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x1c, 0x0F, 0x1c, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x1c, 0x0F, 0x1c, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x0F, 0x1c},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

unsigned char tieSprites[8][8] = {
	{0x06, 0x0F, 0x0F, 0x0F, 0x06, 0x00, 0x00, 0x00},
	{0x00, 0x06, 0x0F, 0x0F, 0x0F, 0x06, 0x00, 0x00},
	{0x00, 0x00, 0x06, 0x0F, 0x0F, 0x0F, 0x06, 0x00},
	{0x00, 0x00, 0x00, 0x06, 0x0F, 0x0F, 0x0F, 0x06},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

unsigned char laserSprites[8][8] = {
	{0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x00},	
	{0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

unsigned char torpedoSprites[8][8] = {
	{0x04, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x04, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x04, 0x0E, 0x04, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x04, 0x0E, 0x04, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x04, 0x0E, 0x04, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0E, 0x04},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

unsigned char tlSprites[8][8] = {
	{0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08},
	{0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x00, 0x00},
	{0x00, 0x00, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

unsigned char spriteTable[8][8] = {
	{0x1c, 0x0F, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00}, //Xwing
	{0x06, 0x0F, 0x0F, 0x0F, 0x06, 0x00, 0x00, 0x00}, //Tie Fighter
	{0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, //Laser 1 (player)
	{0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, //Laser 2 (NPC)
	{0x04, 0x0E, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00}, //Torpedo
	{0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00}, //Turret Laser
	{0x00, 0x00, 0x00, 0x10, 0x0B, 0x07, 0x07, 0x07}, //Turret
	{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x1B}  //Port
};

void loadCustomChar(unsigned char* data, unsigned char index) {
	LCD_WriteCommand(0x40 + (index * 8)); //custom char command
	
	for (unsigned char i = 0; i < 8; i++) {
		LCD_WriteData(data[i]);
	}
}

void loadSpriteTable(unsigned char table[][8], unsigned char tableSize) {
	for (unsigned char i = 0; i < tableSize; i++) {
		loadCustomChar(table[i], i);
	}
}

void printAllSprites(unsigned char pos) {
	for (unsigned char i = 0; i < 8; i++) {
		LCD_Cursor(pos + i);
		LCD_WriteData(i);
	}
}

void initSprites(gameObj sprites[8]) {
	for (unsigned char i = 0; i < 8; i++) { //clear to 0
		memset(&sprites[i], 0, sizeof(sprites[i]));
	}
	
	sprites[0].x = 3;
	sprites[0].y = 1;
	sprites[0].subY = 0;
	sprites[0].subYMax = 5;
	sprites[0].show = 1;
	sprites[0].spriteID = XWING;
	sprites[0].table = xWingSprites;
	loadCustomChar(sprites[0].table[sprites[0].subY], sprites[0].spriteID);
	
	sprites[1].subYMax = 3;
	sprites[1].spriteID = TIE;
	sprites[1].table = tieSprites;
	sprites[1].x = 16;
	sprites[1].show = 1;
	
	sprites[2].subYMax = 5;
	sprites[2].spriteID = LPLAYER;
	sprites[2].table = laserSprites;

	sprites[3].subYMax = 5;
	sprites[3].spriteID = LTIE;
	sprites[3].table = laserSprites;
	
	sprites[4].subYMax = 5;
	sprites[4].spriteID = TORP;
	sprites[4].table = torpedoSprites;
	
	//sprites[5].subYMax = 6;
	sprites[5].spriteID = TURRET;
	//sprites[5].table = tlSprites;
	
	sprites[6].spriteID = TURRET;
	
	sprites[7].spriteID = PORT;
}

void moveY(gameObj *o, int dir) {
	switch(dir) {
		case 1: //up
			if (o->subY > 0) {
				o->subY--;
			} else if (o->y == 1) {
				o->subY = o->subYMax;
				LCD_Cursor(o->x + (16 * o->y));
				LCD_WriteData(' ');
				o->y--; //Y is inverted
			}

			break;
		case -1: //down
			
			if (o->subY < o->subYMax) {
				o->subY++;
			} else if (o->y == 0) {
				o->subY = 0;
				LCD_Cursor(o->x + (16 * o->y));
				LCD_WriteData(' ');
				o->y++;
			}

			break;
	}
	
	loadCustomChar(o->table[o->subY], o->spriteID);
	LCD_Cursor(0);
}

void moveX(gameObj *o, int dir) {
	switch(dir) {
		case -1:
			LCD_Cursor(o->x + (16 * o->y));
			LCD_WriteData(' ');
			if (o->x > 1) {
				o->x--;
			} else {
				o->x = 0;
				o->show = 0;
			}
			break;
		case 1:
			LCD_Cursor(o->x + (16 * o->y));
			LCD_WriteData(' ');
			if (o->x < 16) {
				o->x++;
			} else {
				o->x = 0;
				o->show = 0;
			}
	}
	
	LCD_Cursor(0);
}

void draw(gameObj o) {
	LCD_Cursor(o.x + (16 * o.y));
	LCD_WriteData(o.spriteID);
}